#!/usr/bin/env bash
# Configures a brand new Ubuntu machine to install Nginx and add a custom
# HTTP response header 'X-Served-By' containing the server's hostname.
# The Nginx variable $hostname is used to dynamically inject the server's
# hostname into the response.

# Update package lists
echo "--> Updating package lists..."
sudo apt-get update -y > /dev/null

# Install Nginx
echo "--> Installing Nginx..."
sudo apt-get install -y nginx > /dev/null

# Check if Nginx installed successfully
if [ $? -ne 0 ]; then
    echo "ERROR: Nginx installation failed. Exiting."
    exit 1
fi

# Define the configuration file path
CONFIG_FILE="/etc/nginx/sites-available/default"

# Define the custom header directive
# The $hostname variable must be escaped (\$) so sed passes it literally to Nginx
CUSTOM_HEADER="add_header X-Served-By \$hostname;"

# Use sed to insert the 'add_header' directive immediately after the 'server {' block
# in the default configuration file.
# We first check if the header is already present to prevent duplicate lines.

echo "--> Configuring Nginx to add 'X-Served-By' header..."
if ! grep -q "X-Served-By" "${CONFIG_FILE}"; then
    # Insert the custom header line after the 'server {' line
    sudo sed -i "/server {/a\\  ${CUSTOM_HEADER}" "${CONFIG_FILE}"
    echo "    Header added successfully."
else
    echo "    Header configuration already present. Skipping insertion."
fi

# Restart Nginx to apply the configuration changes
sudo service nginx restart

# Verify the changes (optional check for the user)
echo "--> Configuration complete. You can test with: curl -sI localhost | grep X-Served-By"

exit 0
